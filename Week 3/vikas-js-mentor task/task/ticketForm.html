<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Movie Form</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      defer
      src="https://kit.fontawesome.com/7403d24233.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
      .text-shadow {
        text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.7);
      }
      .form-control:focus,
      .form-select:focus {
        border-color: #dc3545 !important;
        box-shadow: 0 0 5px #dc3545 !important;
      }
      .rounded-form {
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 20px;
        background-color: #fff;
      }
      .error-message {
        color: red;
        font-size: 0.875em;
      }
    </style>
  </head>
  <body class="mb-2">
    <nav class="navbar navbar-expand-lg bg-danger sticky-top">
      <div class="container-fluid">
        <a
          class="navbar-brand text-white text-shadow fs-4"
          href="adminPage.html"
          >ShowTime</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarText"
          aria-controls="navbarText"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarText">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-4">
            <li class="nav-item">
              <a class="nav-link" href="userPage.html" id="showForm"
                >All movies</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="myTickets.html">Booked Tickets</a>
            </li>
          </ul>
          <a href="userLogin.html"
            ><i
              class="fa fa-sign-out text-dark"
              style="font-size: 24px"
              id="logout"
            ></i
          ></a>
        </div>
      </div>
    </nav>

    <div class="container mt-2">
      <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
          <form class="rounded-form" id="movieForm">
            <div class="mt-2">
              <h2 class="text-center text-danger">Book Ticket</h2>
            </div>
            <div class="mb-3">
              <label for="movie-name" class="form-label">Movie Name</label>
              <input
                type="text"
                class="form-control"
                id="movie-name"
                readonly
              />
              <p class="text-danger mx-3 my-2"></p>
            </div>
            <div class="mb-3">
              <select class="form-select theater-select" id="theater">
                <option selected disabled>Select Theater</option>
              </select>
              <p class="text-danger mx-3 my-2"></p>
            </div>

            <div class="row">
              <div class="mb-3 col-md-6">
                <select class="form-select show-select" id="show">
                  <option selected disabled>Select Show</option>
                </select>
                <p class="text-danger mx-3 my-2"></p>
              </div>
              <div class="mb-3 col-md-6">
                <select class="form-select class-select" id="seat-class">
                  <option selected disabled>Select Seat Category</option>
                </select>
                <p class="text-danger mx-3 my-2"></p>
              </div>
            </div>
            <div class="row">
              <div class="mb-3 col-md-6">
                <label for="booking-date" class="form-label">
                  Booking Date</label
                >
                <input type="date" class="form-control" id="booking-date" />
                <p class="text-danger mx-3 my-2"></p>
              </div>
              <div class="mb-3 col-md-6">
                <label for="tickets" class="form-label">Total Tickets</label>
                <input
                  type="number"
                  class="form-control"
                  id="tickets"
                  placeholder="Enter No. of tickets"
                />
                <p class="text-danger mx-3 my-2"></p>
              </div>
            </div>
            <button class="btn btn-danger w-100" id="book-btn">Book</button>
          </form>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      let searchParam = new URLSearchParams(window.location.search);
      let id = searchParam.get("id");
      let movie = JSON.parse(localStorage.getItem("movieData")).find(
        (item) => item.movieName == id
      );
      let ticketData = {};
      let theaters = JSON.parse(localStorage.getItem("theaterData"));

      let formFields = [
        {
          id: "movie-name",
          type: "text",
          label: "Movie name",
          rules: ["required"],
          key: "MovieName",
        },
        {
          id: "theater",
          class: "theater-select",
          type: "select",
          label: "Theater",
          rules: ["required"],
          key: "theater",
        },
        {
          id: "show",
          class: "show-select",
          type: "select",
          label: "Show",
          rules: ["required"],
          key: "shows",
        },
        {
          id: "seat-class",
          class: "class-select",
          type: "select",
          label: "Seat class",
          rules: ["required"],
          key: "seatClass",
        },
        {
          id: "booking-date",
          type: "date",
          label: "Booking Date",
          rules: ["required"],
          key: "bookingDate",
        },
        {
          id: "tickets",
          type: "number",
          label: "Tickets",
          rules: ["required", "min:1"],
          key: "tickets",
        },
      ];
      function validateFormField(field) {
        let value = $(`#${field.id}`).val();
        if (field.type == "select") {
          value = $(`.${field.class}`).val()
            ? $(`.${field.class}`).val().split("-").join(" ")
            : $(`.${field.class}`).val();
        }
        let errorElement = $(`#${field.id} + p`);
        ticketData[field.key] = value;
        for (rule of field.rules) {
          if (rule == "required") {
            if (!value || value.length == 0) {
              $(`#${field.id}`).addClass("is-invalid");
              errorElement.text(`${field.label} is required`);
              return false;
            }
          }
          if (rule.includes("min")) {
            let splittedRule = rule.split(":");
            let minLength = parseInt(splittedRule[1]);
            if (value < minLength) {
              $(`#${field.id}`).addClass("is-invalid");
              errorElement.text(
                `${field.label} should be at least ${minLength}`
              );
              return false;
            }
          }
        }
        $(`#${field.id}`).removeClass("is-invalid");
        $(`#${field.id}`).addClass("is-valid");
        errorElement.text("");
        return true;
      }
      function validateForm() {
        let status = true;
        for (let field of formFields) {
          status = validateFormField(field) && status;
        }
        return status;
      }
      $(document).ready(function () {
        let theaterOptions = movie.theaters.map((theater) => {
          let theaterName = theater.theaterName;
          return `<option value=${theaterName.replace(
            " ",
            "-"
          )}>${theaterName}</option>`;
        });
        $("#movie-name").val(movie.movieName);
        $("#booking-date").val(new Date().toISOString().substring(0, 10));
        $(".theater-select").append(theaterOptions);
        $(".theater-select").on("change", function () {
          let selectedTheater = $(".theater-select").val().split("-").join(" ");
          if (selectedTheater) {
            let showOptions = movie.theaters
              .find((item) => item.theaterName == selectedTheater)
              .showTimings.map(
                (show) =>
                  `<option value=${show.split(" ").join("-")}>${show}</option>`
              );
            $(".show-select").html(showOptions);
            let theater = theaters.find(
              (item) => item.theaterName == selectedTheater
            );

            console.log(theater);
            if (theater) {
              let classOptions = theater.seatCategories.map((seat) => {
                let seatCategories = Object.keys(seat).join();
                return `<option value=${seatCategories.replace(
                  " ",
                  "-"
                )}>${seatCategories}</option>`;
              });
              $(".class-select").html(classOptions);
            }
          }
        });
        $("#book-btn").click(function (e) {
          e.preventDefault();
          if (validateForm()) {
            let theater = theaters.find(
              (item) =>
                item.theaterName == $(".theater-select").val().replace(" ", "-")
            );
            console.log(ticketData);
            localStorage.setItem("ticketInfo", JSON.stringify(ticketData));
            Swal.fire({
              title: "Success!",
              text: "Ticket Booked successfully!",
              icon: "success",
            }).then(() => {
              window.location.href = "myTickets.html";
            });
          }
        });
      });
    </script>
  </body>
</html>
